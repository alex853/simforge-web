<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>airways / Transport Flights</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/requests.js"></script>

    <style>
        .btn-xsm {
            padding: .15rem .35rem;
            font-size: .725rem;
            line-height: 1.5;
            border-radius: .2rem
        }
        .font-xsm {
            font-size: .725rem;
        }
    </style>

</head>
<body>
<div class="container my-5">
    <h2 class="mb-4">Transport Flight Board</h2>
    <div class="mb-3">
        <div class="btn-group" role="group" aria-label="Filter status">
            <button type="button" class="btn btn-outline-primary filter-btn" data-filter="all">All</button>
            <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="actual">Actual</button>
            <button type="button" class="btn btn-outline-primary filter-btn" data-filter="actual-manual">Actual & Manual</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover">
            <colgroup>
                <col>
                <col>
                <col>
                <col>
                <col style="width: 6%;">
                <col style="width: 6%;">
                <col style="width: 6%;">
                <col style="width: 6%;">
                <col style="width: 8%;">
                <col style="width: 4%;">
                <col style="width: 4%;">
                <col style="width: 4%;">
                <col style="width: 8%;">
            </colgroup>
            <thead class="table-dark">
            <tr>
                <th rowspan="2" class="text-center align-middle">ID</th>
                <th rowspan="2" class="text-center align-middle">DOF</th>
                <th rowspan="2" class="text-center align-middle">Heartbeat</th>
                <th rowspan="2" class="text-center align-middle">Status</th>
                <th colspan="2" class="text-center align-middle">Route</th>
                <th colspan="2" class="text-center align-middle">Time</th>
                <th colspan="2" class="text-center align-middle">Tickets</th>
                <th colspan="2" class="text-center align-middle">PAX</th>
                <th rowspan="2" class="text-center align-middle">Actions</th>
            </tr>
            <tr>
                <th class="text-center align-middle">From</th>
                <th class="text-center align-middle">To</th>
                <th class="text-center align-middle">Dep</th>
                <th class="text-center align-middle">Arr</th>
                <th class="text-center align-middle">Total</th>
                <th class="text-center align-middle">Sold</th>
                <th class="text-center align-middle">Ckd In</th>
                <th class="text-center align-middle">On Brd</th>
            </tr>
            </thead>
            <tbody id="table-body">
            <!-- Rows will be inserted here -->
            </tbody>
        </table>
    </div>
</div>

<script>

    let currentFilter = 'actual'; // Default
    let dataIsLoadingNow = false;

    // Update active filter button
    $('.filter-btn').on('click', function () {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        currentFilter = $(this).data('filter');
        reloadData(); // Reload data using new filter
    });

    function updateTableData(data) {
        const $tbody = $('#table-body');
        $tbody.empty();
        data.forEach(item => {
            const row = `
          <tr>
            <td class="text-center align-middle">${item.id}</td>
            <td class="text-center align-middle">${item.dof}</td>
            <td class="text-center align-middle">${item.hrtBt ?? ''}</td>
            <td class="text-center align-middle">${item.st}</td>
            <td class="text-center align-middle">${item.dep}</td>
            <td class="text-center align-middle">${item.dest}</td>
            <td class="text-center align-middle">
                ${item.adep != null && item.adep !== item.pdep 
                      ? `${item.adep}<br><span class="font-xsm">${item.pdep}&nbsp;(p)</span>` 
                      : `${item.pdep}`}
            </td>
            <td class="text-center align-middle">
                ${item.aarr != null 
                      ? (item.aarr !== item.parr ? `${item.aarr}<br><span class="font-xsm">${item.parr}&nbsp;(p)</span>` : `${item.parr}`) 
                      : (item.earr !== item.parr ? `<i>${item.earr}</i><br><span class="font-xsm">${item.parr}&nbsp;(p)</span>` : `${item.parr}`)}
            </td>
            <td class="text-center align-middle">${item.ttkts}</td>
            <td class="text-center align-middle">${item.stkts ?? ''}</td>
            <td class="text-center align-middle">${item.ckdIn ?? ''}</td>
            <td class="text-center align-middle">${item.ponBrd ?? ''}</td>
            <td class="text-center align-middle">
                ${item.pcMode ? `<button type="button" class="btn btn-success btn-xsm" onclick="openFlightDashboard(${item.fmId})">D</button>` : ''}
                <button type="button" class="btn btn-outline-warning btn-xsm" onclick="adminCancel(${item.id})">C</button>
                <button type="button" class="btn btn-outline-danger btn-xsm" onclick="adminRemove(${item.id})">R</button>
            </td>
          </tr>`;
            $tbody.append(row);
        })
    }

    function reloadData() {
        if (dataIsLoadingNow) {
            return;
        }
        dataIsLoadingNow = true;
        airwaysGet('/transport-flight/' + currentFilter, function (response) {
            dataIsLoadingNow = false;
            updateTableData(response);
        }, function () {
            dataIsLoadingNow = false;
        });
    }

    $(document).ready(function () {
        reloadData();

        setInterval(() => reloadData(), 60000);
    });

    function openFlightDashboard(flightId) {
        const url = `./flight-dashboard.html?flightId=${flightId}`;
        window.open(url, 'airways-flight-' + flightId);
    }

    function adminCancel(id) {
        if (!confirm("Do you want to cancel this flight?")) return;
        airwaysGetPlain('/admin/transport-flight/cancel?tfId=' + id, function () {
            reloadData();
        });
    }

    function adminRemove(id) {
        if (!confirm("Do you want to remove this flight?")) return;
        airwaysGetPlain('/admin/transport-flight/remove?tfId=' + id, function () {
            reloadData();
        });
    }

</script>
</body>
</html>
