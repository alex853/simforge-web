<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>airways / Journeys</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/requests.js"></script>

    <style>
        .btn-xsm {
            padding: .15rem .35rem;
            font-size: .725rem;
            line-height: 1.5;
            border-radius: .2rem
        }
        .font-xsm {
            font-size: .725rem;
        }
    </style>

</head>
<body>
<div class="container my-5">
    <h2 class="mb-4">Journeys</h2>
    <!--div class="mb-3">
        <div class="btn-group" role="group" aria-label="Filter status">
            <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">All</button>
            <button type="button" class="btn btn-outline-primary filter-btn" data-filter="actual">Actual</button>
        </div>
    <div-->
    <div class="table-responsive">
        <table class="table font-xsm">
            <colgroup>
                <col style="width: 15%;">
                <col style="width: 5%;">
                <col style="width: 15%;">
                <col style="width: 5%;">
                <col style="width: 15%;">
                <col style="width: 5%;">
                <col style="width: 15%;">
                <col style="width: 5%;">
                <col style="width: 15%;">
                <col style="width: 5%;">
            </colgroup>
            <tr>
                <td>Looking for tickets</td>
                <td id="statsLookingForTickets" class="align-middle"></td>
                <td>Waiting for check-in</td>
                <td id="statsWaitingForCheckIn" class="align-middle"></td>
                <td>On board</td>
                <td id="statsOnBoard" class="align-middle"></td>
                <td>Waiting for deboarding</td>
                <td id="statsWaitingForDeboarding" class="align-middle"></td>
                <td>Finished</td>
                <td id="statsFinished" class="align-middle"></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td>Waiting for boarding</td>
                <td id="statsWaitingForBoarding" class="align-middle"></td>
                <td></td>
                <td></td>
                <td>Just arrived</td>
                <td id="statsJustArrived" class="align-middle"></td>
                <td>Could not find tickets</td>
                <td id="statsCouldNotFindTickets" class="align-middle"></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>Itineraries done</td>
                <td id="statsItinerariesDone" class="align-middle"></td>
                <td>Too late to board</td>
                <td id="statsTooLateToBoard" class="align-middle"></td>
            </tr>
        </table>
        
        <table class="table table-bordered table-striped table-hover">
            <colgroup>
                <col>
                <col>
                <col>
                <col style="width: 8%;"> <!-- Route From -->
                <col style="width: 8%;"> <!-- Route To -->
                <col style="width: 5%;"> <!-- PAX -->
                <col style="width: 10%;"> <!-- T/F 1 -->
                <col style="width: 10%;"> <!-- T/F 2 -->
                <col style="width: 7%;"> <!-- Actions -->
            </colgroup>
            <thead class="table-dark">
            <tr>
                <th rowspan="2" class="text-center align-middle">ID</th>
                <th rowspan="2" class="text-center align-middle">Heartbeat</th>
                <th rowspan="2" class="text-center align-middle">Status</th>
                <th colspan="2" class="text-center align-middle">Route</th>
                <th rowspan="2" class="text-center align-middle">PAX</th>
                <th rowspan="2" class="text-center align-middle">T/F 1</th>
                <th rowspan="2" class="text-center align-middle">T/F 2</th>
                <th rowspan="2" class="text-center align-middle">Actions</th>
            </tr>
            <tr>
                <th class="text-center align-middle">From</th>
                <th class="text-center align-middle">To</th>
            </tr>
            </thead>
            <tbody id="table-body">
            <!-- Rows will be inserted here -->
            </tbody>
        </table>
    </div>
</div>

<script>

    let currentFilter = 'all'; // Default
    let dataIsLoadingNow = false;

    // Update active filter button
/*    $('.filter-btn').on('click', function () {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        currentFilter = $(this).data('filter');
        reloadData(); // Reload data using new filter
    });*/

    function updateTableData(data) {
        const $tbody = $('#table-body');
        $tbody.empty();
        data.forEach(item => {
            const row = `
          <tr>
            <td class="text-center align-middle">${item.id}</td>
            <td class="text-center align-middle">${item.hrtBt ?? ''}</td>
            <td class="text-center align-middle">${item.st}</td>
            <td class="text-center align-middle">${item.fcn}</td>
            <td class="text-center align-middle">${item.tcn}</td>
            <td class="text-center align-middle">${item.cs}${item.gs}</td>
            <td class="text-center align-middle font-xsm">${item.tf1Id
                ? `#${item.tf1Id} - ${item.tf1St}<br>${item.tf1From} - ${item.tf1To}`
                : ''}</td>
            <td class="text-center align-middle font-xsm">${item.tf2Id
                ? `#${item.tf2Id} - ${item.tf2St}<br>${item.tf2From} - ${item.tf2To}`
                : ''}</td>
            <!--td class="text-center align-middle"></td-->
            <td class="text-center align-middle">
                <button type="button" class="btn btn-outline-warning btn-xsm" onclick="adminHeartbeat(${item.id})">H</button>
                <!--button type="button" class="btn btn-outline-danger btn-xsm" onclick="adminRemove(${item.id})">R</button-->
            </td>
          </tr>`;
            $tbody.append(row);
        })
    }

    function updateStats(data) {
        $('#statsLookingForTickets').text(data.LookingForTickets || '');
        $('#statsWaitingForCheckIn').text(data.WaitingForCheckIn || '');
        $('#statsWaitingForBoarding').text(data.WaitingForBoarding || '');
        $('#statsOnBoard').text(data.OnBoard || '');
        $('#statsWaitingForDeboarding').text(data.WaitingForDeboarding || '');
        $('#statsJustArrived').text(data.JustArrived || '');
        $('#statsItinerariesDone').text(data.ItinerariesDone || '');
        $('#statsFinished').text(data.Finished || '');
        $('#statsCouldNotFindTickets').text(data.CouldNotFindTickets || '');
        $('#statsTooLateToBoard').text(data.TooLateToBoard || '');
    }

    function reloadData() {
        if (dataIsLoadingNow) {
            return;
        }
        dataIsLoadingNow = true;
        airwaysGet('/journey/' + currentFilter, function (response) {
            dataIsLoadingNow = false;
            updateTableData(response);
        }, function () {
            dataIsLoadingNow = false;
        });
    }

    function reloadStats() {
        airwaysGet('/journey/stats', function (response) {
            updateStats(response);
        }, function () {
        });
    }

    $(document).ready(function () {
        reloadData();
        reloadStats();

        setInterval(() => reloadData(), 60000);
        setInterval(() => reloadStats(), 60000);
    });

    function adminHeartbeat(id) {
        if (!confirm("Do you want to reset heartbeat to now?")) return;
        airwaysGetPlain('/admin/journey/set-heartbeat-to-now?jId=' + id, function () {
            reloadData();
        });
    }

/*    function adminRemove(id) {
        if (!confirm("Do you want to remove this flight?")) return;
        airwaysGetPlain('/admin/transport-flight/remove?tfId=' + id, function () {
            reloadData();
        });
    }*/

</script>
</body>
</html>
